<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingreso de Pedidos Internos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background-color: #f4f6f9; padding-bottom: 50px; }
        .container { max-width: 800px; margin-top: 40px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        .resumen-caja { background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 20px;}
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center text-primary">Ingreso de Pedidos</h2>

    <form id="pedidoForm">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Nombre *</label>
                <input type="text" class="form-control" id="nombre" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Apellido *</label>
                <input type="text" class="form-control" id="apellido" required>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8 mb-3">
                <label class="form-label">Art√≠culo *</label>
                <select class="form-select" id="articulo" required onchange="calcularTotales()">
                    <option value="" disabled selected>Seleccione un art√≠culo...</option>
                    <option value="COMBO BOCINA Y AUDIFONOS" data-precio="69">COMBO BOCINA Y AUDIFONOS - Q69</option>
                    <option value="COMBO BOCINA Y G63" data-precio="99">COMBO BOCINA Y G63 - Q99</option>
                    <option value="AUDIFONOS CON PANTALLA" data-precio="68">AUDIFONOS CON PANTALLA - Q68</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Cantidad *</label>
                <input type="number" class="form-control" id="cantidad" min="1" value="1" required onchange="calcularTotales()">
            </div>
        </div>

        <hr>

        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Departamento *</label>
                <select class="form-select" id="departamento" required onchange="cargarMunicipios(); calcularTotales();">
                    <option value="" disabled selected>Cargando datos...</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Municipio *</label>
                <select class="form-select" id="municipio" required onchange="cargarPoblados(); calcularTotales();" disabled>
                    <option value="" disabled selected>Seleccione Depto primero</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Poblado *</label>
                <select class="form-select" id="poblado" required disabled>
                    <option value="" disabled selected>Seleccione Municipio primero</option>
                </select>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Direcci√≥n Exacta *</label>
            <input type="text" class="form-control" id="direccion" required>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Tel√©fono 1 *</label>
                <input type="text" class="form-control" id="telefono1" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Tel√©fono 2</label>
                <input type="text" class="form-control" id="telefono2">
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Otras Indicaciones</label>
            <textarea class="form-control" id="indicaciones" rows="2"></textarea>
        </div>

        <div class="alert alert-info text-end">
            <strong>Costo de Env√≠o:</strong> Q<span id="txtEnvio">0.00</span><br>
            <h4 class="mt-2 mb-0"><strong>Total a Cobrar:</strong> Q<span id="txtTotal">0.00</span></h4>
        </div>

        <button type="submit" class="btn btn-primary w-100 py-2 fs-5">Ingresar Pedido</button>
    </form>

    <div id="seccionExito" class="hidden text-center mt-4">
        <div class="alert alert-success fs-4 mb-4">
            ‚úÖ Pedido ingresado satisfactoriamente
        </div>
        
        <div id="reciboPDF" class="resumen-caja text-start">
            <h3 class="text-center mb-3">Resumen de Pedido</h3>
            <p><strong>Cliente:</strong> <span id="resCliente"></span></p>
            <p><strong>Art√≠culo:</strong> <span id="resArticulo"></span> (Cant: <span id="resCantidad"></span>)</p>
            <p><strong>Ubicaci√≥n:</strong> <span id="resUbicacion"></span></p>
            <p><strong>Direcci√≥n:</strong> <span id="resDireccion"></span></p>
            <p><strong>Tel√©fonos:</strong> <span id="resTelefonos"></span></p>
            <p><strong>Indicaciones:</strong> <span id="resIndicaciones"></span></p>
            <hr>
            <h5 class="text-end"><strong>Total:</strong> Q<span id="resTotal"></span></h5>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
            <button type="button" class="btn btn-danger px-4 py-2" onclick="descargarPDF()">üìÑ Guardar PDF</button>
            <button type="button" class="btn btn-success px-4 py-2" onclick="compartirWhatsApp()">üí¨ Compartir en WhatsApp</button>
            <button type="button" class="btn btn-secondary px-4 py-2" onclick="location.reload()">üîÑ Nuevo Pedido</button>
        </div>
    </div>

</div>

<script>
    // ======= CONFIGURACI√ìN DE WHATSAPP =======
    // Escribe aqu√≠ el n√∫mero del departamento al que enviar√°s los datos (ej: 50255554444)
    const NUMERO_DESTINO_WHATSAPP = ""; 
    // =========================================

    let baseDatosCSV = [];
    let pedidoActualTextoWA = "";

    // 1. Cargar el archivo CSV al iniciar la p√°gina
    document.addEventListener("DOMContentLoaded", function() {
        Papa.parse("Guatemala.csv", {
            download: true,
            delimiter: ";", // Importante porque tu archivo usa punto y coma
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                baseDatosCSV = results.data;
                cargarDepartamentos();
            },
            error: function() {
                alert("Error al cargar Guatemala.csv. Aseg√∫rate de que el archivo est√© en la misma carpeta que esta p√°gina y que est√©s usando un servidor local o web.");
            }
        });
    });

    // 2. Llenar los selectores (Comboboxes)
    function cargarDepartamentos() {
        const departamentos = [...new Set(baseDatosCSV.map(item => item.DEPARTAMENTO))].sort();
        const select = document.getElementById('departamento');
        select.innerHTML = '<option value="" disabled selected>Seleccione Departamento...</option>';
        departamentos.forEach(dep => {
            if(dep) select.innerHTML += `<option value="${dep}">${dep}</option>`;
        });
    }

    function cargarMunicipios() {
        const deptoElegido = document.getElementById('departamento').value;
        const selectMuni = document.getElementById('municipio');
        const selectPoblado = document.getElementById('poblado');
        
        const municipios = [...new Set(baseDatosCSV.filter(i => i.DEPARTAMENTO === deptoElegido).map(i => i.MUNICIPIO))].sort();
        
        selectMuni.innerHTML = '<option value="" disabled selected>Seleccione Municipio...</option>';
        municipios.forEach(mun => {
            if(mun) selectMuni.innerHTML += `<option value="${mun}">${mun}</option>`;
        });
        
        selectMuni.disabled = false;
        selectPoblado.innerHTML = '<option value="" disabled selected>Seleccione Municipio primero</option>';
        selectPoblado.disabled = true;
    }

    function cargarPoblados() {
        const deptoElegido = document.getElementById('departamento').value;
        const muniElegido = document.getElementById('municipio').value;
        const selectPoblado = document.getElementById('poblado');
        
        const poblados = [...new Set(baseDatosCSV.filter(i => i.DEPARTAMENTO === deptoElegido && i.MUNICIPIO === muniElegido).map(i => i.POBLADO))].sort();
        
        selectPoblado.innerHTML = '<option value="" disabled selected>Seleccione Poblado...</option>';
        poblados.forEach(pob => {
            if(pob) selectPoblado.innerHTML += `<option value="${pob}">${pob}</option>`;
        });
        selectPoblado.disabled = false;
    }

    // 3. C√°lculos Autom√°ticos
    function calcularTotales() {
        const selectArticulo = document.getElementById('articulo');
        const cantidad = parseInt(document.getElementById('cantidad').value) || 0;
        const depto = document.getElementById('departamento').value || "";
        const muni = document.getElementById('municipio').value || "";

        let precioUnitario = 0;
        if(selectArticulo.selectedIndex > 0) {
            precioUnitario = parseFloat(selectArticulo.options[selectArticulo.selectedIndex].getAttribute('data-precio'));
        }

        let subtotal = precioUnitario * cantidad;
        let costoEnvio = 35; // Default

        // L√≥gica de env√≠o: Si Depto y Municipio coinciden en "Guatemala" (ignorando may√∫sculas/min√∫sculas)
        if (depto.trim().toUpperCase() === "GUATEMALA" && muni.trim().toUpperCase() === "GUATEMALA") {
            costoEnvio = 25;
        } else if (depto === "") {
            costoEnvio = 0; // Si no ha elegido nada a√∫n
        }

        let total = subtotal + costoEnvio;

        document.getElementById('txtEnvio').innerText = costoEnvio.toFixed(2);
        document.getElementById('txtTotal').innerText = total.toFixed(2);
        
        return { total, costoEnvio, precioUnitario, subtotal };
    }

    // 4. Manejo del Formulario (Al hacer clic en Ingresar)
    document.getElementById('pedidoForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Evita que la p√°gina se recargue

        // Consolidar Nombre Completo
        const nombreCompleto = `${document.getElementById('nombre').value.trim()} ${document.getElementById('apellido').value.trim()}`;
        const articuloTexto = document.getElementById('articulo').options[document.getElementById('articulo').selectedIndex].text;
        const cantidad = document.getElementById('cantidad').value;
        
        const depto = document.getElementById('departamento').value;
        const muni = document.getElementById('municipio').value;
        const poblado = document.getElementById('poblado').value;
        
        const direccion = document.getElementById('direccion').value;
        const tel1 = document.getElementById('telefono1').value;
        const tel2 = document.getElementById('telefono2').value;
        const indicaciones = document.getElementById('indicaciones').value;
        
        const calculos = calcularTotales();

        // Llenar datos para el PDF
        document.getElementById('resCliente').innerText = nombreCompleto;
        document.getElementById('resArticulo').innerText = articuloTexto;
        document.getElementById('resCantidad').innerText = cantidad;
        document.getElementById('resUbicacion').innerText = `${depto}, ${muni}, ${poblado}`;
        document.getElementById('resDireccion').innerText = direccion;
        document.getElementById('resTelefonos').innerText = tel2 ? `${tel1} / ${tel2}` : tel1;
        document.getElementById('resIndicaciones').innerText = indicaciones || "Ninguna";
        document.getElementById('resTotal').innerText = calculos.total.toFixed(2);

        // Crear el texto ordenado para WhatsApp
        pedidoActualTextoWA = `*NUEVO PEDIDO INGRESADO* üì¶\n\n` +
                              `*Cliente:* ${nombreCompleto}\n` +
                              `*Tel√©fonos:* ${tel2 ? tel1 + ' / ' + tel2 : tel1}\n\n` +
                              `*Art√≠culo:* ${articuloTexto}\n` +
                              `*Cantidad:* ${cantidad}\n\n` +
                              `*Ubicaci√≥n:* ${depto}, ${muni}, ${poblado}\n` +
                              `*Direcci√≥n:* ${direccion}\n` +
                              `*Indicaciones:* ${indicaciones || 'Ninguna'}\n\n` +
                              `*Env√≠o:* Q${calculos.costoEnvio.toFixed(2)}\n` +
                              `*TOTAL A COBRAR:* Q${calculos.total.toFixed(2)}`;

        // Ocultar formulario, mostrar √©xito
        document.getElementById('pedidoForm').classList.add('hidden');
        document.getElementById('seccionExito').classList.remove('hidden');
    });

    // 5. Bot√≥n Generar PDF
    function descargarPDF() {
        const elemento = document.getElementById('reciboPDF');
        const opciones = {
            margin:       10,
            filename:     'Pedido_Ingresado.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opciones).from(elemento).save();
    }

    // 6. Bot√≥n Compartir en WhatsApp
    function compartirWhatsApp() {
        const urlSegura = encodeURIComponent(pedidoActualTextoWA);
        let linkWA = `https://wa.me/${50258868401}?text=${urlSegura}`;
        window.open(linkWA, '_blank');
    }

</script>
</body>
</html>