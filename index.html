<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Interno v1.0.2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script> <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px 10px; }
        .card { max-width: 600px; margin: auto; border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .login-screen { padding: 40px 20px; text-align: center; }
        .result-box { background: #fff; padding: 25px; border-radius: 10px; border: 1px solid #ccc; line-height: 1.6; }
        hr { border-top: 2px dashed #bbb; }
        b { color: #000; }
        /* Ajuste para que el PDF no corte texto */
        #areaImpresion { font-size: 14px; color: #333; }
    </style>
</head>
<body>

<div id="pantallaLogin" class="card login-screen">
    <h3 class="mb-3">üîê Acceso Restringido</h3>
    <p class="text-muted">Sistema ChapinShopper</p>
    <input type="password" id="passInput" class="form-control mb-3 text-center" placeholder="Ingrese C√≥digo">
    <button onclick="verificarPass()" class="btn btn-primary w-100">Entrar al Sistema</button>
</div>

<div id="contenidoApp" class="card p-4 hidden">
    
    <div id="pantallaFormulario">
        <h3 class="text-center mb-4 text-primary">Nuevo Pedido</h3>
        <form id="formPedido">
            <div class="row">
                <div class="col-6 mb-3">
                    <label class="form-label">NOMBRE *</label>
                    <input type="text" id="nombre" class="form-control" required>
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label">APELLIDO *</label>
                    <input type="text" id="apellido" class="form-control" required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">ART√çCULO *</label>
                <select id="articulo" class="form-select" required onchange="actualizarPrecio()">
                    <option value="" disabled selected>Seleccione art√≠culo...</option>
                    <option value="COMBO BOCINA Y AUDIFONOS" data-precio="69">COMBO BOCINA Y AUDIFONOS - Q69</option>
                    <option value="COMBO BOCINA Y G63" data-precio="99">COMBO BOCINA Y G63 - Q99</option>
                    <option value="AUDIFONOS CON PANTALLA" data-precio="68">AUDIFONOS CON PANTALLA - Q68</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">CANTIDAD *</label>
                <input type="number" id="cantidad" class="form-control" min="1" value="1" required onchange="actualizarPrecio()">
            </div>

            <hr>

            <div class="mb-3">
                <label class="form-label">DEPARTAMENTO *</label>
                <select id="depto" class="form-select" required onchange="filtrarMunicipios()">
                    <option value="">Cargando datos...</option>
                </select>
            </div>
            <div class="row">
                <div class="col-6 mb-3">
                    <label class="form-label">MUNICIPIO *</label>
                    <select id="muni" class="form-select" required disabled onchange="filtrarPoblados()"><option value="">...</option></select>
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label">POBLADO *</label>
                    <select id="poblado" class="form-select" required disabled><option value="">...</option></select>
                </div>
            </div>

            <div class="mb-3">
                <label>DIRECCI√ìN EXACTA *</label>
                <input type="text" id="direccion" class="form-control" required>
            </div>

            <div class="row">
                <div class="col-6 mb-3">
                    <label>TEL√âFONO 1 *</label>
                    <input type="tel" id="tel1" class="form-control" required>
                </div>
                <div class="col-6 mb-3">
                    <label>TEL√âFONO 2</label>
                    <input type="tel" id="tel2" class="form-control">
                </div>
            </div>

            <div class="mb-4">
                <label>OTRAS INDICACIONES</label>
                <textarea id="notas" class="form-control" rows="2"></textarea>
            </div>

            <div class="alert alert-info d-flex justify-content-between fs-5">
                <span>Env√≠o: <b id="envioTxt">Q0</b></span>
                <span>Total: <b id="totalTxt">Q0</b></span>
            </div>

            <button type="submit" class="btn btn-primary w-100 py-3 fw-bold">INGRESAR PEDIDO</button>
        </form>
    </div>

    <div id="pantallaExito" class="hidden text-center">
        <div class="alert alert-success fw-bold">‚úÖ Pedido Generado</div>
        
        <div id="areaImpresion" class="result-box text-start mb-4">
            <h4 class="text-center mb-3 border-bottom pb-2">COMPROBANTE DE PEDIDO</h4>
            <p><b>FECHA:</b> <span id="resFecha"></span></p>
            <p><b>CLIENTE:</b> <span id="resNombre"></span></p>
            <hr>
            <p><b>PRODUCTO:</b> <span id="resArt"></span></p>
            <p><b>CANTIDAD:</b> <span id="resCant"></span></p>
            <p><b>UBICACI√ìN:</b> <span id="resUbi"></span></p>
            <p><b>DIRECCI√ìN:</b> <span id="resDir"></span></p>
            <p><b>TEL√âFONOS:</b> <span id="resTels"></span></p>
            <p><b>NOTAS:</b> <span id="resNotas"></span></p>
            <hr>
            <h3 class="text-end text-primary">TOTAL: <span id="resTotal"></span></h3>
        </div>

        <button onclick="descargarPDF()" class="btn btn-danger w-100 mb-2 py-2">üìÑ 1. Guardar PDF</button>
        <button onclick="enviarWhatsApp()" class="btn btn-success w-100 mb-2 py-2">üí¨ 2. Enviar a Despacho</button>
        <button onclick="location.reload()" class="btn btn-outline-secondary w-100 mt-2">Nuevo Pedido</button>
    </div>
</div>

<script>
    // === CONFIGURACI√ìN ===
    const CLAVE_ACCESO = "1234"; // <--- Tu contrase√±a aqu√≠
    let datosGuate = [];

    // 1. INICIO DE SESI√ìN
    function verificarPass() {
        const input = document.getElementById('passInput').value;
        if(input === CLAVE_ACCESO) {
            document.getElementById('pantallaLogin').classList.add('hidden');
            document.getElementById('contenidoApp').classList.remove('hidden');
            // Iniciamos la carga del CSV solo si la contrase√±a es correcta
            iniciarCargaCSV();
        } else {
            alert("Contrase√±a incorrecta");
        }
    }

    // 2. FUNCI√ìN DE LIMPIEZA DE CARACTERES (Corrige tildes extra√±as)
    function limpiarTexto(t) {
        if(!t) return "";
        return t.replace(/‚Ä°/g, '√°')
                .replace(/‚Äö/g, '√©')
                .replace(/‚Äπ/g, '√≠')
                .replace(/¬†/g, '√≥')
                .replace(/‚ÅÑ/g, '√∫')
                .replace(/¬ç/g, '√±')
                .trim();
    }

    // 3. CARGA DE DATOS ROBUSTA (Usando PapaParse)
    function iniciarCargaCSV() {
        Papa.parse("Guatemala.csv", {
            download: true,
            delimiter: ";",
            header: true, // Asume que la fila 1 son t√≠tulos
            skipEmptyLines: true,
            complete: function(results) {
                if (results.data.length === 0) {
                    alert("El archivo se ley√≥ pero parece vac√≠o. Revisa el CSV.");
                    return;
                }

                // Mapeamos los datos limpiando tildes
                datosGuate = results.data.map(fila => ({
                    d: limpiarTexto(fila.DEPARTAMENTO),
                    m: limpiarTexto(fila.MUNICIPIO),
                    p: limpiarTexto(fila.POBLADO)
                })).filter(item => item.d && item.m); // Filtra filas vac√≠as

                llenarDepartamentos();
            },
            error: function(err) {
                alert("Error cargando 'Guatemala.csv'. Verifica que el nombre sea exacto (May√∫sculas importan) y est√© en GitHub.");
            }
        });
    }

    function llenarDepartamentos() {
        const deptos = [...new Set(datosGuate.map(x => x.d))].sort();
        const s = document.getElementById('depto');
        s.innerHTML = '<option value="">Seleccione Depto...</option>';
        deptos.forEach(d => s.add(new Option(d, d)));
    }

    // 4. FILTROS EN CASCADA
    function filtrarMunicipios() {
        const d = document.getElementById('depto').value;
        const mS = document.getElementById('muni');
        const pS = document.getElementById('poblado');
        
        mS.innerHTML = '<option value="">Seleccione Muni...</option>';
        pS.innerHTML = '<option value="">...</option>';
        pS.disabled = true;

        const munis = [...new Set(datosGuate.filter(x => x.d === d).map(x => x.m))].sort();
        munis.forEach(m => mS.add(new Option(m, m)));
        mS.disabled = false;
        actualizarPrecio();
    }

    function filtrarPoblados() {
        const d = document.getElementById('depto').value;
        const m = document.getElementById('muni').value;
        const pS = document.getElementById('poblado');
        
        pS.innerHTML = '<option value="">Seleccione Poblado...</option>';
        const pobs = [...new Set(datosGuate.filter(x => x.d === d && x.m === m).map(x => x.p))].sort();
        pobs.forEach(p => pS.add(new Option(p, p)));
        pS.disabled = false;
        actualizarPrecio();
    }

    // 5. C√ÅLCULOS
    function actualizarPrecio() {
        const art = document.getElementById('articulo');
        const cant = document.getElementById('cantidad').value;
        const d = document.getElementById('depto').value;
        const m = document.getElementById('muni').value;

        if(!art.value) return;

        let pArt = parseFloat(art.options[art.selectedIndex].getAttribute('data-precio'));
        
        // Regla de env√≠o: Solo Guatemala/Guatemala paga Q25, resto Q35
        let envio = 35;
        if (d === "GUATEMALA" && m === "GUATEMALA") {
            envio = 25;
        }
        if (!d) envio = 0; // Si no ha elegido depto, mostramos 0

        document.getElementById('envioTxt').innerText = "Q" + envio;
        document.getElementById('totalTxt').innerText = "Q" + ((pArt * cant) + envio);
    }

    // 6. GUARDAR PEDIDO
    let msgWA = "";
    document.getElementById('formPedido').onsubmit = function(e) {
        e.preventDefault();
        
        const nom = document.getElementById('nombre').value.toUpperCase() + " " + document.getElementById('apellido').value.toUpperCase();
        const ubi = `${document.getElementById('depto').value}, ${document.getElementById('muni').value}, ${document.getElementById('poblado').value}`;
        const tels = document.getElementById('tel1').value + (document.getElementById('tel2').value ? " / " + document.getElementById('tel2').value : "");
        const f = new Date();
        const fechaStr = f.toLocaleDateString('es-GT');
        const totalDinero = document.getElementById('totalTxt').innerText;

        // Llenar datos visuales
        document.getElementById('resFecha').innerText = fechaStr;
        document.getElementById('resNombre').innerText = nom;
        document.getElementById('resArt').innerText = document.getElementById('articulo').value;
        document.getElementById('resCant').innerText = document.getElementById('cantidad').value;
        document.getElementById('resUbi').innerText = ubi;
        document.getElementById('resDir').innerText = document.getElementById('direccion').value;
        document.getElementById('resTels').innerText = tels;
        document.getElementById('resNotas').innerText = document.getElementById('notas').value || "Ninguna";
        document.getElementById('resTotal').innerText = totalDinero;

        // Crear Texto WhatsApp
        msgWA = `*NUEVO PEDIDO - ${fechaStr}* üì¶%0A` +
                `*CLIENTE:* ${nom}%0A` +
                `*ART√çCULO:* ${document.getElementById('articulo').value}%0A` +
                `*CANTIDAD:* ${document.getElementById('cantidad').value}%0A` +
                `*UBICACI√ìN:* ${ubi}%0A` +
                `*DIRECCI√ìN:* ${document.getElementById('direccion').value}%0A` +
                `*TEL√âFONOS:* ${tels}%0A` +
                `*NOTAS:* ${document.getElementById('notas').value || " - "}%0A` +
                `*TOTAL A COBRAR:* ${totalDinero}`;

        document.getElementById('pantallaFormulario').classList.add('hidden');
        document.getElementById('pantallaExito').classList.remove('hidden');
    };

    // 7. FUNCIONES DE BOTONES
    function descargarPDF() {
        const el = document.getElementById('areaImpresion');
        const opt = { 
            margin: 10, 
            filename: `Pedido_${document.getElementById('resNombre').innerText}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 }, 
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
        };
        html2pdf().set(opt).from(el).save();
    }

    function enviarWhatsApp() {
        // Como es web, no puede adjuntar archivo solo. El usuario debe adjuntar el PDF descargado.
        const numeroEmpresa = "502"; 
        window.open(`https://wa.me/${numeroEmpresa}?text=${msgWA}`, '_blank');
    }
</script>

</body>
</html>
